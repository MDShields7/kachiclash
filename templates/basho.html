{% extends "base.html" %}

{% block main_id %}p-basho{% endblock %}

{% block subtitle %}{{basho.id}}{% endblock %}

{% block head %}
    <script src="/static/js/basho.js" defer></script>
    <link rel="stylesheet" href="/static/css/basho.css">
{% endblock %}

{% block main %}

    <header>
        <img src="/static/img/banner-1.jpg" width="950" height="406" alt="Kachi Clash banner">
        <h3>RULES</h3>
        <p>Pick ONE rikishi from EACH of the RANKED SECTIONS:</p>
        <p>Y-O | S-K | M1-M5 | M6-M10 | M11-M17</p>
        <p>Each time one of your picks wins a bout, you get 1 point.</p>
        <p>During the basho, players are ranked according to their # of wins, and first-place will earn a coveted üèÜ EMPEROR'S CUP üèÜ next to your name for all future Kachi Clash contests.</p>

        {% if !basho.has_started() %}
            <p>You can freely change your picks until the basho starts on {{basho.start_date.format("%Y-%m-%d %H:%M")}} JST.</p>

            <div id="basho-count-down" data-start-date="{{basho.start_date.timestamp_millis()}}">
                Time remaining: <span id="basho-count-down-time"></span>
            </div>
        {% endif %}
    </header>

    <h2>{{basho.id}} ‚Äî {{basho.venue}}</h2>

    {% if base.is_admin() %}
        <section id="admin">
            <h2>Admin Controls</h2>
            <ul>
                <li><a href="{{basho.id.url_path()}}/edit">edit banzuke</a></li>
                <li><a href="{{basho.id.url_path()}}/day/{{next_day}}">enter day {{next_day}} results</a></li>
            </ul>
        </section>
    {% endif %}

    {% if basho.has_started() %}
        <section id="leaderboard">
            <h2>Leaderboard</h2>
            <table>
                <thead>
                    <th>Player</th>
                    {% for day in 1..16 -%}
                        <th>{{day}}</th>
                    {% endfor -%}
                    <th>Total</th>
                </thead>
                <tbody>
                {% for player in leaders -%}
                    <tr>
                        <td><a href="/player/{{player.id}}">{{player.name}}</a></td>
                        {%- for wins in player.days -%}
                            <td>
                            {%- match wins -%}
                                {%- when Some with (num) %}{{num}}
                                {%- when None %}-
                            {%- endmatch -%}
                            </td>
                        {% endfor -%}
                        <td>{{player.total}}</td>
                    </tr>
                {%- endfor %}
                </tbody>
            </table>
        </section>
    {% else %}
        <p>
            {{basho.player_count}} entries:
            {% for player in leaders %}
                <a href="/player/{{player.id}}">{{player.name}}</a>
                {%- if !loop.last -%},{% endif %}
            {%- endfor %}
        </p>
    {% endif %}

    <section id="banzuke"
        {% if !basho.has_started() && base.player.is_some() %}class="selectable"{% endif %}
    >
        <h2>Banzuke</h2>

        {% if !basho.has_started() -%}
            {%- if base.player.is_some() -%}
                <p>Select one rikishi from each group below below:</p>
            {%- else -%}
                <p><a href="/login">Log in or sign up</a> to play!</p>
            {%- endif -%}
        {%- endif %}
        
        <form id="banzuke-select-rikishi-form" action="{{basho.id.url_path()}}/picks">
            <table>
                <thead>
                    <th colspan="2">East</th>
                    <th class="rank">Rank</th>
                    <th colspan="2">West</th>
                </thead>
                <tbody>
                    {% for rr in rikishi_by_rank -%}
                        <tr class="rank-group-{{rr.rank_group}}">
                            {%- call rikishi_results(rr.east) -%}
                            <td class="rank">{{rr.rank}}</td>
                            {%- call rikishi_results(rr.west) -%}
                        </tr>
                    {% endfor -%}
                </tbody>
            </table>
        </form>
    </section>
{% endblock %}

{%- macro rikishi_results(rikishi) -%}
    {%- match rikishi -%}
    {%- when Some with (rikishi) -%}
        <td class="rikishi {% if rikishi.is_player_pick -%} is-player-pick {%- endif %}"
            data-rikishi-id="{{rikishi.id}}"
        >
            <label>
                <input type="radio" class="select-radio"
                    name="rank-group-{{rikishi.rank.group()}}"
                    value="{{rikishi.id}}"
                    {% if rikishi.is_player_pick -%} checked {%- endif %}
                    {% if basho.has_started() -%} disabled {%- endif %}
                >
                {{- rikishi.name -}}
            </label>
        </td>
        <td class="hoshi {% if rikishi.is_player_pick && basho.has_started() -%} is-player-pick {%- endif %}">
        {%- for day in rikishi.results -%}
            {%- match day -%}
                {%- when Some with (true) -%}‚ö™Ô∏è
                {%- when Some with (false) -%}‚ö´Ô∏è
                {%- when None -%}‚Äî
            {%- endmatch -%}
        {%- endfor -%}
        </td>
    {%- when None -%}
        <td></td>
        <td></td>
    {%- endmatch -%}
{%- endmacro -%}
